ORG 0x0
V0: WORD $TIMER, 0x180
V1: WORD $CALL_PRINT, 0x180
V2: WORD $DEFAULT, 0x180
V3: WORD $DEFAULT, 0x180
V4: WORD $DEFAULT, 0x180
V5: WORD $DEFAULT, 0x180
V6: WORD $DEFAULT, 0x180
V7: WORD $DEFAULT, 0x180
DEFAULT: IRET

TIME: WORD 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
SUBANS: WORD 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0

TIME_START: WORD $TIME
SUBANS_START: WORD $SUBANS


XP_I: WORD 0x0

N: WORD 0x0

CLEAR: WORD 0x0 ;0- НЕ ЧИСТИТЬ, 1 - ЧИСТИТЬ

OPER_POS: WORD 0x0
LOOP_COUNTER: WORD 0x0
NUMBER_LENGTH: WORD 0x8

CALL_PRINT:
PUSHF
DI
IN 0x4

LD SUBANS_START
PUSH
CALL PRINT_NUMBER
	
LD #0x3A			;  :
CALL PRINT_LETTER

LD #0x09			;  \t
CALL PRINT_LETTER

LD TIME_START
PUSH
CALL PRINT_NUMBER



LD #0x1
ST CLEAR

LD #0x0A		;\n LF
CALL PRINT_LETTER



POPF
IRET

CLEAR_NUMBER:
LD &0x1
ST OPER_POS
LD NUMBER_LENGTH
ST LOOP_COUNTER
CLEAR_LOOP: CLA
ST (OPER_POS)+
LOOP LOOP_COUNTER
JUMP CLEAR_LOOP
SWAP
ST &0x1
POP
RET

TIMER:
PUSHF
DI
IN 0
LD TIME_START
PUSH
CALL INC_NUMBER

LD SUBANS_START
PUSH
LD CLEAR
BEQ INCC
CALL CLEAR_NUMBER

CLA
ST CLEAR

LD SUBANS_START
PUSH
INCC:CALL INC_NUMBER

LD TIME_START
PUSH
CALL SHOW
POPF
IRET

WAIT_TIME: WORD 1

START: CLA
OUT 1
OUT 3
OUT 5
OUT 7
LD #0x8 ;1000 -> 
OUT 0x1
LD #0x9 ;1001 -> 
OUT 0x5
LD WAIT_TIME		
OUT 0x0

EI
MAIN_LOOP: 
JUMP MAIN_LOOP


SHOW: LD NUMBER_LENGTH
ST N
LD &0x1
ST XP_I
PRINT_LOOP:
LD #0x8					;ЯЧЕЙКА
SUB N
ASL
ASL
ASL
ASL
ADD (XP_I)+
PUSH
S1: IN 0x15
AND #0x40
BEQ S1
POP
OUT 0x14
LOOP N
JUMP PRINT_LOOP
SWAP
ST &0x1
POP					;SWAP x2
RET

INC_NUMBER:
LD &0x1
ST OPER_POS
LD NUMBER_LENGTH
ST LOOP_COUNTER
CLC
CMC
LOOPP:
CLA
ADC (OPER_POS)
CMP #0xA
BMI CHANGE_PL				  ;>=10
ADD #0x6
CLC
CMC
CHANGE_PL: 
AND #0xF
ST (OPER_POS)+
BCC FINISH_INC
LOOP LOOP_COUNTER
JUMP LOOPP
FINISH_INC: 
SWAP
ST &0x1;2xSWAP
POP
RET

PRINT_LETTER:
PUSH
S2: IN 0xD
AND #0x40
BEQ S2
POP
OUT 0xC
RET

PRINT_NUMBER: LD NUMBER_LENGTH
ST NP
LD &0x1
ADD NUMBER_LENGTH
ST XP_IP
PRINT_NUMBER_LOOP:
LD  -(XP_IP)
ADD #0x30
CALL PRINT_LETTER
LD NP
CMP #0x2
BNE CONT_PRINT

LD #0x2E
CALL PRINT_LETTER

CONT_PRINT: LOOP NP
JUMP PRINT_NUMBER_LOOP
SWAP
ST &0x1
POP		;2xSWAP
RET

NP: WORD 0x0
XP_IP: WORD 0x0